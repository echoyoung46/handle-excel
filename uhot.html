<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>UHOT 面辅料信息处理</title>
    <script lang="javascript" src="dist/xlsx.core.min.js"></script>
    <script src="dist/cpexcel.js"></script>
    <script src="dist/ods.js"></script>
    <style>
      #drop{
        border:2px dashed #bbb;
        -moz-border-radius:5px;
        -webkit-border-radius:5px;
        border-radius:5px;
        padding:25px;
        text-align:center;
        font:20pt bold,"Vollkorn";color:#bbb
      }
      #result{
        border:2px dashed #ddd;
        margin-top: 50px;
        padding: 10px;
      }
    </style>
</head>
<body>
<div id="drop">Drop an XLSX / XLSM / XLSB / ODS / XLS / XML file here to see sheet data</div>
<div id="result"></div>
<script>
    /* 固定文件路径 */
    // var url = "uhot.xlsx";
    // var oReq = new XMLHttpRequest();
    // oReq.open("GET", url, true);
    // oReq.responseType = "arraybuffer";

    // oReq.onload = function(e) {
    //   var arraybuffer = oReq.response;

    //   /* convert data to binary string */
    //   var data = new Uint8Array(arraybuffer);
    //   var arr = new Array();
    //   for(var i = 0; i != data.length; ++i) arr[i] = String.fromCharCode(data[i]);
    //   var bstr = arr.join("");

    //   /* Call XLSX */
    //   var workbook = XLSX.read(bstr, {type:"binary"});

    //   handleExcel(workbook);
    //   /* DO SOMETHING WITH workbook HERE */
    // }

    // oReq.send();
    
    /* 拖拽上传文件 */
    var drop = document.getElementById('drop'),
        result = document.getElementById('result');
    function handleDrop(e) {
      e.stopPropagation();
      e.preventDefault();
      var files = e.dataTransfer.files;
      var i,f;
      for (i = 0, f = files[i]; i != files.length; ++i) {
        var reader = new FileReader();
        var name = f.name;
        reader.onload = function(e) {
          var data = e.target.result;

          /* if binary string, read with type 'binary' */
          var workbook = XLSX.read(data, {type: 'binary'});
          
          handleExcel(workbook);

          /* DO SOMETHING WITH workbook HERE */
        };
        reader.readAsBinaryString(f);
      }
    }
    function handleDragover(e) {
      e.stopPropagation();
      e.preventDefault();
      e.dataTransfer.dropEffect = 'copy';
    }
    if(drop.addEventListener) {
      drop.addEventListener('dragenter', handleDragover, false);
      drop.addEventListener('dragover', handleDragover, false);
      drop.addEventListener('drop', handleDrop, false);
    }
    
    
    //uhot逻辑代码
    var worksheet = null,
        currRow = 0,
        idCell = 'F', colorCell = 'G', countCell = 'K';
        uhot = [];
    /**
     * 得到起始位置
     * _workbook 表格
     */
    function handleExcel (_workbook){
        var sheet_name_list = _workbook.SheetNames;
        sheet_name_list.forEach(function(y) { /* iterate through sheets */
          worksheet = _workbook.Sheets[y];
          for (z in worksheet) {
            /* all keys that do not begin with "!" correspond to cell addresses */
            if(z[0] === '!') continue;
            if(worksheet[z].v == '确认版'){
              var startRow = parseInt(z.replace(/[^0-9]/ig,"")) + 2;
              currRow = startRow;
              // console.log(y + "!" + z + "=" + JSON.stringify(worksheet[z].v));
              getInfo(startRow);
            }
          }
        });
        result.innerHTML = "";
        console.log(result.innerHTML);
        result.innerHTML = JSON.stringify(uhot);
    }
    
    
    
    /** 
     * 取到所有编号、色号和下单量
     * _row 从第几行开始取
     */
    function getInfo(_row) {
      var cell = idCell + _row;
      // var uhotId = JSON.stringify(worksheet[cell].v);
      if( typeof worksheet[cell] != 'undefined' &&  worksheet[cell] != 'undefined' ){
        uhot.push({
          id: JSON.stringify(worksheet[cell].v),
          color: JSON.stringify(worksheet[colorCell+_row].v),
          count: JSON.stringify(worksheet[countCell+_row].v)
        });
        currRow++;
        getInfo(currRow);
      }else{
        return false;
      }
    }
    
</script>    
</body>
</html>